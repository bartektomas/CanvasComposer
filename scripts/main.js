"use strict";function roundToGrid(e){return Math.round(e/grid)*grid}function fixBoundaries(e){if(e.target){var t=e.target,a=!1,r={left:t.left,right:t.left+t.width*t.scaleX,top:t.top,bottom:t.top+t.height*t.scaleY},o={left:0,top:0,right:canvas.getWidth(),bottom:canvas.getHeight()},i={};return r.left<o.left&&(a=!0,i.left=o.left),r.top<o.top&&(a=!0,i.top=o.top),r.right>o.right&&(a=!0,i.left=r.left-(r.right-o.right)),r.bottom>o.bottom&&(a=!0,i.top=r.top-(r.bottom-o.bottom)),a&&(t.set(i),canvas.renderAll()),e}}function snapMoveToGrid(e){var t=e.target,a=t.width*t.scaleX,r=t.height*t.scaleY,o={top:roundToGrid(t.top),left:roundToGrid(t.left),bottom:roundToGrid(t.top+r),right:roundToGrid(t.left+a)},i={top:Math.abs(o.top-t.top),left:Math.abs(o.left-t.left),bottom:Math.abs(o.bottom-t.top-r),right:Math.abs(o.right-t.left-a)};i.bottom<i.top?i.bottom>threshold?o.top=t.top:o.top=o.bottom-r:i.top>threshold&&(o.top=t.top),i.right<i.left?i.right>threshold?o.left=t.left:o.left=o.right-a:i.left>threshold&&(o.left=t.left),t.set({top:o.top,left:o.left})}function snapScaleToGrid(e){var t=e.target,a=t.getWidth(),r=t.getHeight(),o={top:roundToGrid(t.top),left:roundToGrid(t.left),bottom:roundToGrid(t.top+r),right:roundToGrid(t.left+a)},i={top:Math.abs(o.top-t.top),left:Math.abs(o.left-t.left),bottom:Math.abs(o.bottom-t.top-r),right:Math.abs(o.right-t.left-a)},n={scaleX:t.scaleX,scaleY:t.scaleY,top:t.top,left:t.left};switch(t.__corner){case"tl":i.left<i.top&&i.left<threshold?(n.scaleX=(a-(o.left-t.left))/t.width,n.scaleY=n.scaleX/t.scaleX*t.scaleY,n.top=t.top+(r-t.height*n.scaleY),n.left=o.left):i.top<threshold&&(n.scaleY=(r-(o.top-t.top))/t.height,n.scaleX=n.scaleY/t.scaleY*t.scaleX,n.left=n.left+(a-t.width*n.scaleX),n.top=o.top);break;case"mt":i.top<threshold&&(n.scaleY=(r-(o.top-t.top))/t.height,n.top=o.top);break;case"tr":i.right<i.top&&i.right<threshold?(n.scaleX=(o.right-t.left)/t.width,n.scaleY=n.scaleX/t.scaleX*t.scaleY,n.top=t.top+(r-t.height*n.scaleY)):i.top<threshold&&(n.scaleY=(r-(o.top-t.top))/t.height,n.scaleX=n.scaleY/t.scaleY*t.scaleX,n.top=o.top);break;case"ml":i.left<threshold&&(n.scaleX=(a-(o.left-t.left))/t.width,n.left=o.left);break;case"mr":i.right<threshold&&(n.scaleX=(o.right-t.left)/t.width);break;case"bl":i.left<i.bottom&&i.left<threshold?(n.scaleX=(a-(o.left-t.left))/t.width,n.scaleY=n.scaleX/t.scaleX*t.scaleY,n.left=o.left):i.bottom<threshold&&(n.scaleY=(o.bottom-t.top)/t.height,n.scaleX=n.scaleY/t.scaleY*t.scaleX,n.left=n.left+(a-t.width*n.scaleX));break;case"mb":i.bottom<threshold&&(n.scaleY=(o.bottom-t.top)/t.height);break;case"br":i.right<i.bottom&&i.right<threshold?(n.scaleX=(o.right-t.left)/t.width,n.scaleY=n.scaleX/t.scaleX*t.scaleY):i.bottom<threshold&&(n.scaleY=(o.bottom-t.top)/t.height,n.scaleX=n.scaleY/t.scaleY*t.scaleX)}t.set(n)}function artboardScale(){var e=(canvas.width/canvas.height,canvas.width/container.clientWidth),t=canvas.height/container.clientHeight;console.log("W:"+e),console.log("H:"+t);var a;e>=t?e>1?(e=container.clientWidth/canvas.width,a=e*e,console.log(e),a>1&&(a=1),paintArea.style.transform="scale("+a+")",paintArea.style.transformOrigin="25% 25%"):(a=1,paintArea.style.transform="scale("+a+")",paintArea.style.transformOrigin="25% 25%"):t>e&&(t>1?(t=container.clientHeight/canvas.height,a=t*t,console.log(t),a>1&&(a=1),paintArea.style.transform="scale("+a+")",paintArea.style.transformOrigin="45% 25%"):(a=1,paintArea.style.transform="scale("+a+")",paintArea.style.transformOrigin="25% 25%"))}function bindEvents(e){e.on("selected",function(){console.log("selected"),$(".objectControl").addClass("active"),"i-text"===e.type?($(".text-attr").show(),$(".basic-attr").hide()):($(".text-attr").hide(),$(".basic-attr").show()),$("#config").fadeTo("fast",.9),instantMeta.log(e)}),canvas.on("before:selection:cleared",function(){console.log("deselected"),$(".objectControl").removeClass("active"),$("#config").fadeOut("fast"),instantMeta.clean()}),e.on("scaling",function(){console.log("scaling"),instantMeta.log(e)}),e.on("moving",function(){console.log("moving"),instantMeta.log(e)}),e.on("rotating",function(){console.log("rotating"),instantMeta.log(e)}),e.on("changed",function(){console.log("Exited"),instantMeta.log(e)})}function getIdx(e,t,a){return _.chain(e).pluck(t).indexOf(a).value()}function in_array(e,t){for(var a=0;a<e.length;a++)if(console.log(e[a]),e[a].id===t)return!0;return!1}function logObj(){$("#console .shapeobj .content").html(JSON.stringify(canvas.toJSON())),$("#console .canvasobj .content").html(JSON.stringify(canvas))}fabric.Video=fabric.util.createClass(fabric.Image,{type:"video"}),fabric.Slider=fabric.util.createClass(fabric.Rect,{type:"slider"}),fabric.Slider.fromArray=function(e,t,a){fabric.util.loadImage(e,function(e){t&&t(new fabric.Slider(e,a))},null,a&&a.crossOrigin)},fabric.Video.fromURL=function(e,t,a){fabric.util.loadImage(e,function(e){t&&t(new fabric.Video(e,a))},null,a&&a.crossOrigin)},fabric.Object.prototype.id={},fabric.Object.prototype.media={slider:"",slides:[],video:""};var canvas=new fabric.Canvas("c",{selectionColor:"blue",selectionLineWidth:2,width:800,height:600}),grid=50,threshold=.2*grid;canvas.on("object:moving",snapMoveToGrid),canvas.on("object:scaling",snapScaleToGrid),canvas.on("object:moving",fixBoundaries),canvas.on("object:scaling",fixBoundaries);var container=document.getElementById("artboard"),paintArea=document.getElementById("canvas");artboardScale(),$(window).resize(function(){artboardScale()}),$("#canvasWidth").on("change paste keyup",function(){canvas.setWidth($(this).val()),canvas.renderAll(),artboardScale(),$(".sizeTag .tag.width span").html($(this).val())}),$("#canvasHeight").on("change paste keyup",function(){canvas.setHeight($(this).val()),canvas.renderAll(),artboardScale(),$(".sizeTag .tag.height span").html($(this).val())}),$("#canvas-select").change(function(){var e=$("#canvas-select option:selected").attr("data-width"),t=$("#canvas-select option:selected").attr("data-height");$("#widthValue").val(e),$("#heightValue").val(t),canvas.setWidth(e),canvas.setHeight(t),canvas.renderAll(),artboardScale(),$(".sizeTag .tag.width span").html(e),$(".sizeTag .tag.height span").html(t)}),$(".tools").on("click","a",function(){var e=$(this).attr("class");switch(e){case"js-add-rect":Artboard.addRect();break;case"js-add-circle":Artboard.addCircle();break;case"js-add-text":Artboard.addText();break;case"js-dispose":Artboard.dispose();break;case"js-setting":$("#canvassetting").fadeTo("fast",.9)}}),$(".objectControl").on("click","button",function(){var e=$(this).attr("class");switch(e){case"js-delete":Artboard.removeObject();break;case"js-reset":Artboard.reset()}}),$(".objectSize").on("change",function(){var e,t,a,r,o=canvas.getActiveObject();e=o.width,t=o.height,a=$("#objectWidth").val()/e,r=$("#objectHeight").val()/t,o.setScaleX(a),o.setScaleY(r),o.setCoords(),canvas.renderAll()}),$("#objectColor").spectrum({showInput:!0,className:"full-spectrum",showInitial:!0,showPalette:!0,showSelectionPalette:!0,maxSelectionSize:10,preferredFormat:"hex",localStorageKey:"spectrum.demo",move:function(e){},show:function(){},beforeShow:function(){},hide:function(){},change:function(e){var t=canvas.getActiveObject();"i-text"===t.type?(t.setTextBackgroundColor(e),console.log(e)):t.setFill(e),canvas.renderAll(),$("#objectColor").spectrum("hide")},palette:[["rgb(0, 0, 0)","rgb(67, 67, 67)","rgb(102, 102, 102)","rgb(204, 204, 204)","rgb(217, 217, 217)","rgb(255, 255, 255)"],["rgb(152, 0, 0)","rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(74, 134, 232)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],["rgb(230, 184, 175)","rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(201, 218, 248)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)","rgb(221, 126, 107)","rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(164, 194, 244)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)","rgb(204, 65, 37)","rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(109, 158, 235)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)","rgb(166, 28, 0)","rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(60, 120, 216)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)","rgb(91, 15, 0)","rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(28, 69, 135)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]]}),$("#objectTextColor").spectrum({showInput:!0,className:"full-spectrum",showInitial:!0,showPalette:!0,showSelectionPalette:!0,maxSelectionSize:10,preferredFormat:"hex",localStorageKey:"spectrum.demo",move:function(e){},show:function(){},beforeShow:function(){},hide:function(){},change:function(e){var t=canvas.getActiveObject();"i-text"===t.type&&t.setFill(e),canvas.renderAll(),$("#objectTextColor").spectrum("hide")},palette:[["rgb(0, 0, 0)","rgb(67, 67, 67)","rgb(102, 102, 102)","rgb(204, 204, 204)","rgb(217, 217, 217)","rgb(255, 255, 255)"],["rgb(152, 0, 0)","rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(74, 134, 232)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],["rgb(230, 184, 175)","rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(201, 218, 248)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)","rgb(221, 126, 107)","rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(164, 194, 244)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)","rgb(204, 65, 37)","rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(109, 158, 235)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)","rgb(166, 28, 0)","rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(60, 120, 216)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)","rgb(91, 15, 0)","rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(28, 69, 135)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]]}),$(".js-library").on("click",function(){$("#mediaLibrary").addClass("active"),selected.length=0,$("#mediaLibrary .selection").empty(),$("#mediaLibrary .resources a").removeClass("active")}),$("#mediaLibrary .js-close").on("click",function(){$("#mediaLibrary").removeClass("active")});var selected=[];$("#mediaLibrary .resources").on("click","a",function(){$(this).toggleClass("active");var e,t,a,r;t=$(this).attr("data-src"),e=$(this).find(".filename").html(),r=$(this).attr("data-resourceid"),a="5";var o="<li data-resourceid="+r+"><div class='order'><div class='continued'><input type='number' value='"+a+"'></div></div><div class='description'><div class='filename'>"+e+"</div></div></li>";if(in_array(selected,r))$(".settings-container .selection li").each(function(){var e=$(this).attr("data-resourceid");if(e===r){$(this).remove();var t=getIdx(selected,"id",e);t>-1&&selected.splice(t,1),console.log(selected)}});else{$(".settings-container .selection").append(o);var i={id:r,src:t,continued:a};selected.push(i),console.log(selected)}}),$(".js-sendToObj").on("click",function(){if(1===selected.length){var e=selected[0].src;$("#mediaValue").val(e);var t=canvas.getActiveObject(),a=e;console.log(a),null==t?alert("未選取任何物件"):(void 0!==t._element&&"video"===t._element.localName?(t.getElement().pause(),t.remove()):t.remove(),Artboard.addMedia(a),canvas.renderAll(),t.center(),t.setCoords(),logObj()),$(this).parents("#mediaLibrary").removeClass("active")}else if(selected.length>1){var t=canvas.getActiveObject();null==t?alert("未選取任何物件"):t.remove(),Artboard.addMedia(selected),canvas.renderAll(),t.center(),t.setCoords(),logObj(),$(this).parents("#mediaLibrary").removeClass("active")}else alert("未選擇任何素材")});var map={8:!1,91:!1,187:!1,189:!1,40:!1,38:!1,68:!1,17:!1,76:!1};$(document).keydown(function(e){if(e.keyCode in map)if(map[e.keyCode]=!0,map[8]&&map[91])e.preventDefault(),e.stopPropagation(),Artboard.removeObject();else if(map[38]&&map[91]){e.preventDefault(),e.stopPropagation();var t=canvas.getActiveObject();t.bringToFront(),map[38]=!1}else if(map[187]&&map[91]){e.preventDefault(),e.stopPropagation();var t=canvas.getActiveObject();t.bringForward(),map[187]=!1}else if(map[189]&&map[91]){e.preventDefault(),e.stopPropagation();var t=canvas.getActiveObject();t.sendBackwards(),map[189]=!1}else if(map[40]&&map[91]){e.preventDefault(),e.stopPropagation();var t=canvas.getActiveObject();t.sendToBack(),map[40]=!1}else map[68]&&map[17]?(e.preventDefault(),e.stopPropagation(),Artboard.duplicateObject(),map[68]=!1):map[76]&&map[91]&&(e.preventDefault(),e.stopPropagation(),Artboard.lockObject(),map[76]=!1)}).keyup(function(e){e.keyCode in map&&(map[e.keyCode]=!1)});var instantMeta={log:function(e){console.log(e.toObject());var t,a,r,o,i,n,c,l,s,g,d,b;t=e.width*e.scaleX,a=e.height*e.scaleY,r=e.scaleX,o=e.scaleY,i=e.radius,n=e.left,c=e.top,l=e.angle,s=e.type,d="i-text"===e.type?e.textBackgroundColor:e.fill,b=e.fill,$(".attributes-wrapper .type input").val(s),$(".attributes-wrapper .width input").val(t),$(".attributes-wrapper .height input").val(a),$(".attributes-wrapper .radius input").val(i),$(".attributes-wrapper .angle input").val(l),$(".attributes-wrapper .top input").val(c),$(".attributes-wrapper .left input").val(n),$(".attributes-wrapper .media input").val(g),$(".attributes-wrapper .scalex input").val(r),$(".attributes-wrapper .scaley input").val(o),$("#objectColor").spectrum("set",d),$("#objectTextColor").spectrum("set",b),logObj()},clean:function(e){$(".attributes-wrapper input").val(""),$(".attributes-wrapper .mediaPreview").empty(),console.log("clean")}},initRadius=100,Artboard=function(){return{addRect:function(){var e=new fabric.Rect({left:canvas.getWidth()/2-initRadius/2,top:canvas.getHeight()/2-initRadius/2,fill:"#"+Math.floor(16777215*Math.random()).toString(16),width:initRadius,height:initRadius});e.perPixelTargetFind=!0,canvas.add(e),bindEvents(e),canvas.setActiveObject(e),logObj()},addCircle:function(){var e=new fabric.Circle({left:canvas.getWidth()/2-initRadius/2,top:canvas.getHeight()/2-initRadius/2,fill:"#"+Math.floor(16777215*Math.random()).toString(16),radius:initRadius/2});e.perPixelTargetFind=!0,canvas.add(e),bindEvents(e),canvas.setActiveObject(e),logObj()},addText:function(){var e=new fabric.IText("test",{left:200,top:200,lockScalingX:!0,lockScalingY:!0});canvas.add(e),bindEvents(e),canvas.setActiveObject(e),logObj()},addMedia:function(e){if((""===e||void 0===e)&&(e="images/uploads/abc.png"),"[object Array]"===Object.prototype.toString.call(e))Multimedia.slider(e);else{var t=e.split(".").pop(),a=validateYouTubeUrl(e);if(0!=a){getThumbnails(a,function(e){console.log(e),Multimedia.video(e,a)})}else t.match(/^(gif|png|jpg|jpeg|tiff|svg)$/)?Multimedia.image(e):t.match(/^(mp4|avi|ogg|ogv|webm)$/)?Multimedia.video(e):console.log("不支援此檔案格式，請重試")}},dispose:function(){for(var e=0;e<canvas._objects.length;e++)void 0!==canvas._objects[e]._element&&"video"===canvas._objects[e]._element.localName?canvas._objects[e].getElement().pause():console.log("error");canvas.clear(),logObj()},duplicateObject:function(){var e=canvas.getActiveObject();canvas.add(e.clone()),canvas.renderAll()},lockObject:function(){var e=canvas.getActiveObject();e.lockMovementY===!0?(e.lockMovementY=!1,e.lockMovementX=!1,e.lockRotation=!1,e.lockScalingX=!1,e.lockScalingY=!1):(e.lockMovementY=!0,e.lockMovementX=!0,e.lockRotation=!0,e.lockScalingX=!0,e.lockScalingY=!0)},removeObject:function(){var e=canvas.getActiveObject();void 0!==e._element&&"video"===e._element.localName?(e.getElement().pause(),e.remove()):e.remove()},reset:function(){var e=canvas.getActiveObject();e.setScaleX("1"),e.setScaleY("1"),e.center(),e.setCoords(),canvas.renderAll(),instantMeta.log(e)}}}(),Multimedia=function(){return{image:function(e){new fabric.Image.fromURL(e,function(e){e.set({left:canvas.getWidth()/2-e.width/2,top:canvas.getHeight()/2-e.height/2}),canvas.add(e),e.center(),e.setCoords(),canvas.renderAll(),bindEvents(e),canvas.setActiveObject(e),logObj()})},video:function e(t,a){if(void 0!=a){console.log(t);new fabric.Video.fromURL(t,function(e){e.set({left:canvas.getWidth()/2-e.width/2,top:canvas.getHeight()/2-e.height/2}),canvas.add(e),e.center(),e.setCoords(),canvas.renderAll(),bindEvents(e),canvas.setActiveObject(e),logObj()})}else{console.log("match video");var r,o,i=document.createElement("video");i.loop=!0,i.controls=!0,console.log(i),i.innerHTML='<source src="'+t+'">';var e=new fabric.Video(i,{});canvas.add(e),i.onloadeddata=function(){r=this.videoWidth,o=this.videoHeight,e.setWidth(r),e.setHeight(o),e.center(),e.setCoords(),canvas.renderAll()},e.getElement().play(),e.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{media:{video:t}})}}(e.toObject),bindEvents(e),canvas.setActiveObject(e),logObj(),fabric.util.requestAnimFrame(function n(){canvas.renderAll(),fabric.util.requestAnimFrame(n)})}},slider:function(e){new fabric.Image.fromURL(e[0].src,function(t){function a(t){l=clearInterval(l),console.log(e),t++,t===e.length&&(t=0);new fabric.Image.fromURL(e[t].src,function(e){e.setHeight(r.height),e.setWidth(r.width),r.setBackgroundImage(e),r.renderAll(),canvas.renderAll()});c=1e3*e[t].continued,console.log(c),l=setInterval(function(){a(t)},c)}var r=new fabric.StaticCanvas;t.setHeight(r.height),t.setWidth(r.width),r.setBackgroundImage(t),r.renderAll();var o=new fabric.Pattern({source:function(){return r.getElement()},repeat:"no-repeat"}),i=new fabric.Slider({left:canvas.getWidth()/2-t.getWidth()/2,top:canvas.getHeight()/2-t.getHeight()/2,fill:o,width:t.getWidth(),height:t.getHeight()});canvas.add(i),i.toObject=function(t){return function(){return fabric.util.object.extend(t.call(this),{slides:[e]})}}(i.toObject),console.log(i),canvas.renderAll();var n=0,c=1e3*e[0].continued,l=setInterval(function(){a(n)},c);bindEvents(i),canvas.setActiveObject(i),logObj()})},clock:function(){},iframe:function(){}}}(),el=document.getElementById("selectionOrder"),sortable=Sortable.create(el),Typekit;!function(e){var t,a={kitId:"daf4cqp",scriptTimeout:3e3,async:!0},r=e.documentElement,o=setTimeout(function(){r.className=r.className.replace(/\bwf-loading\b/g,"")+" wf-inactive"},a.scriptTimeout),i=e.createElement("script"),n=!1,c=e.getElementsByTagName("script")[0];r.className+=" wf-loading",i.src="https://use.typekit.net/"+a.kitId+".js",i.async=!0,i.onload=i.onreadystatechange=function(){if(t=this.readyState,!(n||t&&"complete"!=t&&"loaded"!=t)){n=!0,clearTimeout(o);try{Typekit.load(a)}catch(e){}}},c.parentNode.insertBefore(i,c)}(document);